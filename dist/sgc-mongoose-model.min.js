define("Collection/mixins/collectionPropertiesDefinitions",[],function(){return function(){return{defineSchemaProperties:function(){if(this.schema){var t={},e=function(t){return function(){return this.get(t)}},i=function(t){return function(){return function(){var e=Array.apply(null,arguments);return this["do"].apply(this,[t,e[0],e[1]])}}};this.schema.virtuals.keys().forEach(function(i){t[i]={get:e(i)}}),this.schema.actions.keys().forEach(function(e){t[e]={get:i(e)}}),Object.defineProperties(this,t)}},addGetterProperty:function(t){if(t){var e=function(t){return function(){return this.get(t)}},i={};i["id_"+t]={get:e(t)},Object.defineProperties(this,i)}},"do":function(){}}}}),define("Error/ModelError",[],function(){var t=function(t){t=_.defaults(t||{},{verbose:"Unknow",identifier:0,model:null}),this.verbose=t.verbose,this.identifier=t.identifier,this.model=t.model};return t}),define("Collection/mixins/collectionValidation",["../../Error/ModelError"],function(t){return function(){return{validate:function(t,e){for(var i,n=0;n<this.models.length;n++)if(i=this.models[n].validate&&this.models[n].validate(t,e))return i},generateError:function(e,i){return new t({verbose:e,identifier:i,model:this})}}}}),define("Collection/mixins/collectionHelpers",[],function(){return function(){return{}}}),define("Collection/mixins/collectionSync",[],function(){return function(){return{getAttr:function(){},JSONFromSchema:function(t){if(t=_.defaults(t||{},{schemaFormat:void 0}),!t.schemaFormat)return this.JSONFromSchema(this.mongooseSchema);var e=[];return this.each(function(i){var n=t.schemaFormat.getContent();e.push(i.JSONFromSchema({schemaFormat:n}))}),e}}}}),define("Collection/Collection",["./mixins/collectionPropertiesDefinitions","./mixins/collectionValidation","./mixins/collectionHelpers","./mixins/collectionSync"],function(t,e,i,n){var o=require("sgc-model").Collection,r=o.extend({constructor:function(t,e){!t||t instanceof Array||(e=t),this._virtuals={},this.defineSchemaProperties(),o.prototype.constructor.apply(this,arguments)},__isAVirtual:function(t){return!!this.mongooseSchemaForVirtual(t)},mongooseSchemaForVirtual:function(t){return this.mongooseSchema&&this.mongooseSchema.collection&&this.mongooseSchema.collection[t]?this.mongooseSchema.collection&&this.mongooseSchema.collection[t]:!1},getVirtualAttribute:function(t){var e=this._virtuals[t];if(void 0!==e)return e;var i=this.mongooseSchemaForVirtual(t);if(i instanceof app.MongooseArraySchema){var n=i.getCollectionClass();e=new n(null,{parent:{instance:this,path:""},url:this.url+"/"+t})}return this.setVirtualAttribute(t,e),this._virtuals[t]},setVirtualAttribute:function(t,e){this._virtuals[t]=e},get:function(t,e){if(t instanceof this.model)return o.prototype.get.apply(this,arguments);var i=this.url instanceof Function?this.url():this.url;if(this.__isAVirtual(t))return this.getVirtualAttribute(t,e);if("new"===t){var n=new this.model({},{urlRoot:i,parent:{instance:this,path:""}});return e&&e.add&&this.add(n),n}return o.prototype.get.apply(this,arguments)},getBySlug:function(t){var e=this.findWhere({slug:t}),i=this.url instanceof Function?this.url():this.url;return e||(this.add(new this.model({slug:t},{urlRoot:i,parent:{instance:this,path:""}})),e=this.last()),e}});return _.extend(r.prototype,i(r)),_.extend(r.prototype,t(r)),_.extend(r.prototype,n(r)),_.extend(r.prototype,e(r)),r}),define("Model/mixins/modelSchemaPropertiesDefinition",[],function(){return function(){return{_defineActionFunction:function(){var t={},e=this,i=function(t){return function(){return function(e,i){return this["do"].apply(this,[t,e,i])}}};this.mongooseSchema.getActions().keys().forEach(function(n){n in e&&(n="_"+n),t[n]={get:i(n)}}),Object.defineProperties(this,t)},_defineAttributesProperties:function(){this._generateGetSetForAttributes(this.schemaAttributes())},schemaAttributes:function(){return this.mongooseSchema.getAttributes().keys()},defineSchemaProperties:function(){this.mongooseSchema&&(this._defineAttributesProperties(),this._defineActionFunction())}}}}),define("Model/mixins/modelSchemaValidation",["../../Collection/Collection","../../Error/ModelError"],function(t,e){return function(){return{generateError:function(t,i){return new e({verbose:t,identifier:i,model:this})},validate:function(t,e){e=_.defaults(e||{},{attrsToValidate:null}),t=t||this.mongooseSchema.getAttributes(),e.attrsToValidate&&(t=e.attrsToValidate);for(var i,n=_.keys(t),o=0;o<n.length;o++)if(i=this.checkAttrIsValid(n[o],t,e))return i},checkAttrIsValid:function(t,e,i){return t=this.get(t,{lazyCreation:!1}),t&&t.validate?t.validate(e,i):void 0}}}}),define("Model/mixins/modelSchemaAction",[],function(){return function(){return{"do":function(){}}}}),define("Model/mixins/modelSchemaSetter",["../../Collection/Collection"],function(){return function(t){return{recordCollectionsChanges:function(t){var e=this.getAllCollections();for(var i in e)this.recordCollectionChanges(i,e[i],t)},recordCollectionChanges:function(t,e,i){if(i){var n=this;this.listenTo(e,"add",function(e){n.recordChange(t,{add:e})}),this.listenTo(e,"remove",function(e){n.recordChange(t,{remove:e})})}else this.stopListening(e,"add"),this.stopListening(e,"remove")},startRecordingChange:function(){this.set("record-change",!1),this.recordCollectionsChanges(!0),this._isRecordingChanges=!0},stopRecordingChange:function(){this.set("record-change",!1),this.recordCollectionsChanges(!1),this._isRecordingChanges=!1},resetRecord:function(){this.set("record-change",!1);var t=this._recorded;return this._recorded={},t},recordedChanges:function(){return this._recorded},isRecordingChanges:function(){return!!this._isRecordingChanges},markAsChanged:function(t){this.recordChange(t,"fake")},recordChange:function(t,e){var i=this.get(t,{lazyCreation:!1});e!==i&&(this.set("record-change",!0,{record:!1}),t in this._recorded||(this._recorded[t]=[]),this._recorded[t].push(e))},setMSchemaAttribute:function(t,e,i){var n=this.get(t,{rawData:e});if(void 0!==n){if(this._isACollectionAttribute(t))return n.set(e),this.trigger("change:"+t,this,e),void this.listenTo(n,"add remove",function(e,i,n){this.trigger("change:"+t,e,i,n)},this);if(this._isAModelAttribute(t))return _.isString(e)?n.set("_id",e):n.set(e),void this.trigger("change:"+t,this,e)}return this._isADateAttribute(t)&&(e=new Date(e)),Backbone.Model.prototype.set.apply(this,[t,e,i])},set:function(t,e,i){if(i=_.defaults(i||{},{record:!0}),this.isRecordingChanges()&&i.record&&_.isString(t)&&this.recordChange(t,e),t&&_.isString(t)){if(t in this.mongooseSchema)return this.setMSchemaAttribute(t,e,i);if(_.isObject(e)&&!e instanceof Backbone.Model)for(var n in e)this.set(t+"."+n,e[n]);return Backbone.Model.prototype.set.apply(this,[t,e,i])}return t&&t.isObject()?(i=e,this.batchSet(t,i)):Backbone.Model.prototype.set.apply(this,[t,e,i])},batchSet:function(e,i){if(e instanceof t)return Backbone.Model.prototype.set.apply(this,[e.toJSON(),i]);var n=[];_.each(e,function(t,e){void 0!==t&&this._isARelationship(e)&&n.push(e)},this);for(var o=0;o<n.length;o++)this.set(n[o],e[n[o]]);return _.each(e,function(t,e){this.set(e,t,i)},this),this.trigger("batch-update",this.changed),this}}}}),define("Model/mixins/modelSchemaGetter",[],function(){return function(t){return{__generateModelFor:function(t){var e=this.mongooseSchema[t],i=e.getModelClass();return new i({},{url:this._generateUrl()+"/"+t,parent:{instance:this,path:t},mongooseSchema:this})},__generateCollectionFor:function(t){var e=this.mongooseSchema[t],i=e.getCollectionClass();if(!i)return[];var n=this._generateUrl()+"/"+t,o=new i([],{parent:{instance:this,path:t},url:n});return o},_isARelationship:function(t){if("_id"===t)return!1;var e=this.mongooseSchema[t];return e?this._isACollectionAttribute(t)?!0:this._isAModelAttribute(t)?!0:!1:!1},_isACollectionAttribute:function(t){return this.mongooseSchema[t]instanceof app.MongooseArraySchema&&this.mongooseSchema[t].getCollectionClass()},_isAModelAttribute:function(t){return"_id"===t?!1:this._isAPrimitive(t)&&this.mongooseSchema[t].isModelReference()?!0:this.mongooseSchema[t]instanceof app.MongooseSchema?!0:!1},_isADateAttribute:function(t){return this._isAPrimitive(t)&&"Date"===this.mongooseSchema[t].type},_isAPrimitive:function(t){return this.mongooseSchema[t]instanceof app.MongoosePrimitiveSchema},getMSchemaAttribute:function(e,i){var n=this.mongooseSchema[e],o=null;return this._isACollectionAttribute(e)&&(o=this.__generateCollectionFor(e,i)),this._isAModelAttribute(e)&&(o=this.__generateModelFor(e,i)),n instanceof app.MongoosePrimitiveSchema&&n.freeType()&&(o={}),o&&t.__super__.set.apply(this,[e,o]),o},get:function(e,i){if(i=_.defaults(i||{},{lazyCreation:!0}),e.contains(".")){var n=e.split(".")[0],o=this.get(n,{lazyCreation:i.lazyCreation});if(o&&o instanceof Backbone.Model){var r=e.slice(n.length+1,e.length);return o.get(r,{lazyCreation:i.lazyCreation})}}var s=t.__super__.get.apply(this,arguments);if(!i.lazyCreation)return s;if(void 0!==s)return s;var a=this.mongooseSchema[e];return a?this.getMSchemaAttribute(e,i):s},getAllCollections:function(t){var e=this.mongooseSchema.getAttributes(),i={};for(var n in e)if(this._isACollectionAttribute(n)){var o=this.get(n,t);void 0!==o&&(i[n]=o)}return i},getAllModels:function(t){var e={},i=this.mongooseSchema.getAttributes();for(var n in i)if(this._isAModelAttribute(n)){var o=this.get(n,t);void 0!==o&&o instanceof Backbone.Model&&(e[n]=o)}return e}}}}),define("Model/mixins/modelSchemaSync",["../../Collection/Collection"],function(){return function(t){return{_generateUrl:function(){return _.isFunction(this.url)?this.url():this.url},url:function(t){return this.custom_url?this.custom_url:!this._id&&this.slug||t&&t.slug?this.urlRoot.endsWith("/")?this.urlRoot+this.slug:this.urlRoot+"/"+this.slug:(this.urlRoot||this.collection||(this.urlRoot="/api/"+this.mongooseSchema.getCollectionName()+"/"),Backbone.Model.prototype.url.apply(this,arguments))},save:function(t,e){if(e=_.defaults(e||{},{schemaSerialization:!1,attributeToKeep:t,recordedChanges:!1}),e.attrsToValidate=t,e.recordedChanges&&this.stopRecordingChange(),e.recordedChanges){var i=e.success;e.success=function(t,e,n){i&&i(t,e,n),n.recordedChanges&&(t.resetRecord(),t.startRecordingChange())}}return Backbone.Model.prototype.save.apply(this,[void 0,e])},destroy:function(){var t=Backbone.Model.prototype.destroy.apply(this,arguments),e=this;return t&&t.done(function(){e.trigger("sync:destroy")}),t},fetch:function(t,e,i){if(is.String(t)){var n=this._generateUrl();n.endsWith("/")||(n+="/");var o=SGAjax.ajax({url:n+t,type:"GET",data:e});if(i&&i.merge){var r=this;o.done(function(e){r[t]=e})}return o}return Backbone.Model.prototype.fetch.apply(this,arguments)},toJSON:function(t){t=_.defaults(t||{},{schemaSerialization:!1,notmpath:void 0,attributeToKeep:null,recordedChanges:!1}),t.recordedChanges&&(t.attributeToKeep=_.keys(this.recordedChanges()));var e=null;return e=t.schemaSerialization?this.JSONFromSchema(t):this._JSONFromAttr(t),t.attributeToKeep&&(e=_.pick(e,t.attributeToKeep)),"record-change"in e&&delete e["record-change"],e},_JSONFromAttr:function(e){if(this._isId)return this._id;var i;i=e.notmpath!==!0?Backbone.Model.prototype.toJSON.apply(this,arguments):_.clone(this._mattributes||{});var n=function(i){for(var o in i)if(i[o]&&"function"==typeof i[o].toJSON){var r=i[o].toJSON(e);i[o]instanceof t?r&&!r.isEmpty()?i[o]=r:delete i[o]:i[o]=r}else(_.isObject(i[o])||_.isArray(i[o]))&&n(i[o])};return n(i),i},JSONFromSchema:function(t){if(t=_.defaults(t||{},{schemaFormat:void 0}),!t.schemaFormat)return this.JSONFromSchema({schemaFormat:this.mongooseSchema});if(t.schemaFormat instanceof app.MongoosePrimitiveSchema){if(this.isNew()){var e=this.JSONFromSchema({schemaFormat:this.mongooseSchema});return e.keys().length?e:void 0}return this._id}var i={},n=t.schemaFormat.getAttributes();t.schemaFormat.isASemiEmbedded()&&(n=_.pick(n,"_id"));for(var o in n){var r=n[o],s=this.get(o,{lazyCreation:!1});if(void 0!==s){if(_.isObject(s)&&"JSONFromSchema"in s){var a=s.JSONFromSchema({schemaFormat:r});void 0!==a&&(i[o]=a);continue}i[o]=s}}return i}}}}),define("Model/Model",["./mixins/modelSchemaPropertiesDefinition","./mixins/modelSchemaValidation","./mixins/modelSchemaAction","./mixins/modelSchemaSetter","./mixins/modelSchemaGetter","./mixins/modelSchemaSync"],function(t,e,i,n,o,r){var s=require("sgc-model").Model,a=s.extend({constructor:function(t,e){e&&("custom_url"in e&&(this.custom_url=e.custom_url),"url"in e&&(this.urlRoot=e.url),"urlRoot"in e&&(this.urlRoot=e.urlRoot),e.parent&&(this.parent=e.parent),this.isValidationRef=e.isValidationRef),this._originalAttributes={},this.defineSchemaProperties();var i=s.prototype.constructor.apply(this,arguments);return this.postCreate&&this.postCreate(e),this._recorded={},this.set("record-change",!1),i},_isRecordingChanges:null,_recorded:null,idAttribute:"_id",parent:{instance:null,path:null},primitiveTypes:["String","Number","Boolean","Date","ObjectId"],_isId:!1,root:function(){for(var t=this,e="";t.parent.instance;){var i=t.parent;t=i.instance,e+=i.path}return{instance:t,path:e}},revert:function(){for(var t in this._originalAttributes)this.set(t,this._originalAttributes[t])},treeVirtuals:function(){return this.schema.virtuals.clone().merge(this.schema.tree)},clear:function(t){t=_.defaults(t||{},{recursive:!0});var e=this.getAllCollections({lazyCreation:!1});for(var i in e)e[i].clear();var n=this.getAllModels({lazyCreation:!1});for(i in n)n[i].clear(t);return this.parent=null,window.instances[this.cid]="cleared",s.prototype.clear.apply(this,arguments)},validForSave:function(){return null},__tIsValid:function(t){return App.__t_valids?App.__t_valids.contains(t):!1},clone:function(){var t=s.prototype.clone.apply(this,arguments);for(var e in t.attributes)t.attributes[e]instanceof a&&(t.attributes[e]=t.attributes[e].clone()),t.attributes[e]instanceof SagaCollection&&(t.attributes[e]=t.attributes[e].clone({models:!0}));return t}});return _.extend(a.prototype,i(a)),_.extend(a.prototype,t(a)),_.extend(a.prototype,n(a)),_.extend(a.prototype,r(a)),_.extend(a.prototype,e(a)),_.extend(a.prototype,o(a)),a}),define("sgc-mongoose-model",["require","./Collection/Collection","./Model/Model"],function(t){var e=t("./Collection/Collection"),i=t("./Model/Model");return{Collection:e,Model:i}});